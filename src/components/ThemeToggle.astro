---
// src/components/ThemeToggle.astro
// ダークモード/ライトモード切り替えボタンコンポーネント
---

<button id="theme-toggle" class="theme-toggle" aria-label="テーマを切り替え">
	<svg class="sun-icon" viewBox="0 0 16 16" width="20" height="20" aria-hidden="true">
		<path fill="currentColor" d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
	</svg>
	<svg class="moon-icon" viewBox="0 0 16 16" width="20" height="20" aria-hidden="true">
		<path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"/>
	</svg>
</button>

<script is:inline>
	// @ts-nocheck
	// テーマ切り替えのロジック（リフローを最小化）
	(function() {
		const themeToggle = document.getElementById('theme-toggle');
		const html = document.documentElement;
		
		// 保存されたテーマを取得、またはシステム設定を確認
		function getInitialTheme() {
			const savedTheme = localStorage.getItem('theme');
			if (savedTheme === 'dark' || savedTheme === 'light') {
				return savedTheme;
			}
			// システム設定を確認
			return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
		}
		
		// テーマを適用（リフローを最小化）
		function setTheme(theme) {
			if (theme !== 'dark' && theme !== 'light') return;
			// requestAnimationFrameを使用してリフローを最適化
			requestAnimationFrame(function() {
				html.setAttribute('data-theme', theme);
				localStorage.setItem('theme', theme);
			});
		}
		
		// 初期テーマを設定（ページ読み込み前に実行してFOUCを防ぐ）
		const initialTheme = getInitialTheme();
		if (initialTheme === 'dark' || initialTheme === 'light') {
			html.setAttribute('data-theme', initialTheme);
		}
		
		// DOMContentLoaded後にボタンのイベントリスナーを設定
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initThemeToggle);
		} else {
			initThemeToggle();
		}
		
		function initThemeToggle() {
			// ボタンクリック時の処理
			if (themeToggle) {
				themeToggle.addEventListener('click', function() {
					const currentTheme = html.getAttribute('data-theme');
					const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
					setTheme(newTheme);
				});
			}
			
			// システム設定の変更を監視
			window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
				// ユーザーが手動でテーマを設定していない場合のみシステム設定に従う
				if (!localStorage.getItem('theme')) {
					setTheme(e.matches ? 'dark' : 'light');
				}
			});
		}
	})();
</script>

<style>
	.theme-toggle {
		background: none;
		border: none;
		cursor: pointer;
		padding: 0.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--color-text);
		transition: color 0.2s ease;
		border-radius: 0.25rem;
	}
	
	.theme-toggle:hover {
		color: var(--color-primary);
		background-color: var(--color-background);
	}
	
	.theme-toggle:focus {
		outline: 2px solid var(--color-primary);
		outline-offset: 2px;
	}
	
	.moon-icon {
		display: none;
	}
	
	.sun-icon {
		display: block;
	}
	
	/* ダークモード時は月アイコンを表示 */
	[data-theme="dark"] .moon-icon {
		display: block;
	}
	
	[data-theme="dark"] .sun-icon {
		display: none;
	}
</style>
